{"version":3,"sources":["webpack:///./src/views/stake/index.vue","webpack:///./src/views/stake/index.vue?ce6d","webpack:///./src/views/stake/index.vue?f1c2"],"names":["class","_createElementVNode","_createElementBlock","_createVNode","_component_HeadTop","title","isShowTop","isSubHeader","_hoisted_3","_component_van_cell","style","is-link","value","_ctx","text","onClick","_component_van_field","$event","center","clearable","label","placeholder","extra","_hoisted_4","_toDisplayString","Number","_createBlock","_component_van_button","color","type","loading","swaploading","size","loading-text","block","_component_van_popup","show","round","position","_component_van_picker","columns","onCancel","onConfirm","components","HeadTop","setup","store","useStore","data","reactive","address","computed","state","accounts","web3","provider","intro","get","config","rootAddress","swapContract","KttContract","KtmContract","kttAllowance","kttBalance","kttAmount","ktmAmount","showPicker","btn","swapKttAmount","swapAmount","pickerValue","initContract","eth","Contract","swapAbi","swapAddress","kttContract","tokenAbi","kttAddress","ktmContract","ktmAddress","initData","getBalance","getKttAllowance","getAllStakeType","methods","call","types","periodTime","arr","forEach","item","push","period","rate","id","getOutKtmAmount","decimals","kttDecimals","balanceOf","BigNumber","dividedBy","toFixed","allowance","approveKtt","approve","MaxUint256","send","from","Toast","swapKtm","getUserInfo","introUserInfo","userUserInfo","AddressZero","amount","multipliedBy","stake","_","throttle","ktmDecimals","getKtmAmount","price","watch","val","refData","toRefs","__exports__","render"],"mappings":"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","file":"static/js/chunk-00a9554b.1252e8e9.js","sourcesContent":["<template>\n  <div class=\"swap\">\n    <HeadTop title=\"质押\" :isShowTop=\"true\" :isSubHeader=\"false\"></HeadTop>\n    <div class=\"swap-item\">\n        <div class=\"title\">质押KTT</div>\n          <van-cell title=\"选择质押周期\" style=\"margin-bottom: 15px\" is-link :value=\"pickerValue.text\" @click=\"showPicker = true\"/>\n          <van-field\n    v-model=\"swapAmount\"\n    center\n    clearable\n    label=\"\"\n    @update:model-value=\"getOutKtmAmount\"\n    placeholder=\"请输入质押数量\"\n  >\n    <template #extra>\n      <span class=\"sympol\">KTT</span>\n    </template>\n  </van-field>\n  <div class=\"flex-between\">\n    <div class=\"price-desc\">获得: <span>{{ktmAmount}}</span> KTM</div>\n    <div class=\"price-desc\">余额: <span>{{kttBalance}}</span> KTT</div>\n  </div>\n  \n  <div class=\"button-box\">\n    <van-button color=\"linear-gradient(90deg, #5161F5 0%, #64C5FA 100%)\" type=\"primary\" :loading=\"btn.swaploading\" size=\"large\" loading-text=\"质押中...\" block v-if=\"Number(kttAllowance) > 0\" @click=\"swapKtm\">质押</van-button>\n     <van-button color=\"linear-gradient(90deg, #5161F5 0%, #64C5FA 100%)\" type=\"primary\" :loading=\"btn.swaploading\" v-else size=\"large\" loading-text=\"正在授权...\" @click=\"approveKtt\">授权KTT</van-button>\n  </div>\n    </div>\n    <van-popup v-model:show=\"showPicker\" round position=\"bottom\">\n  <van-picker\n    :columns=\"columns\"\n    @cancel=\"showPicker = false\"\n    @confirm=\"onConfirm\"\n  />\n</van-popup>\n  </div>\n</template>\n<script>\nimport HeadTop from '@/components/HeadTop'\nimport { reactive, toRefs, computed, watch } from \"vue\";\nimport { useStore } from \"vuex\";\nimport { MaxUint256, AddressZero } from \"@ethersproject/constants\";\nimport BigNumber from 'bignumber.js';\nimport _ from 'lodash'\nimport swapAbi from \"@/utils/swapAbi\";\nimport tokenAbi from \"@/utils/abi\";\nimport config from \"@/utils/config\";\nimport { Toast } from 'vant';\nimport { intro } from '@/storage'\n\nexport default {\n  components: {\n    HeadTop\n  },\n  setup () {\n    const store = useStore()\n    const data = reactive({\n      address: computed(() => store.state.accounts[0]),\n      web3: computed(() => store.state.provider),\n      intro: intro.get() || config.rootAddress,\n      swapContract: null,\n      KttContract: null,\n      KtmContract: null,\n      kttAllowance: '',\n      kttBalance: '0.00',\n      kttAmount: '0.00',\n      ktmAmount: '0.00',\n      showPicker: false,\n       btn: {\n        loading: false,\n        swaploading: false\n      },\n      swapKttAmount: '',\n      swapAmount: '',\n      pickerValue: null,\n      columns: [],\n      initContract: () => {\n        data.swapContract = new data.web3.eth.Contract(swapAbi, config.swapAddress)\n        data.kttContract = new data.web3.eth.Contract(tokenAbi, config.kttAddress)\n        data.ktmContract = new data.web3.eth.Contract(tokenAbi, config.ktmAddress)\n        data.initData()\n      },\n      initData: () => {\n        data.getBalance()\n        data.getKttAllowance()\n        data.getAllStakeType()\n      },\n      getAllStakeType: async () => {\n        let types = await data.swapContract.methods.getAllStakeType().call()\n        let periodTime = await data.swapContract.methods.periodTime().call()\n        let arr = []\n        console.log(types)\n        types.forEach(item => {\n          arr.push({\n            text: `${Number(item.period/periodTime)}天,${item.rate/10000}倍`,\n            value: item.id,\n            rate: item.rate\n          })\n        });\n        data.columns = arr\n        data.pickerValue = arr[0]\n      },\n      onConfirm: (value) => {\n        data.pickerValue = value\n        data.showPicker = false\n        data.getOutKtmAmount()\n      },\n      getBalance: async () => {\n        let kttDecimals = await data.kttContract.methods.decimals().call()\n        let kttBalance = await data.kttContract.methods.balanceOf(data.address).call()\n        data.kttBalance =  new BigNumber(kttBalance).dividedBy(10 ** kttDecimals).toFixed(2)\n      },\n       getKttAllowance: async () => {\n        let allowance = await data.kttContract.methods.allowance(data.address, config.swapAddress).call()\n        data.kttAllowance = allowance;\n      },\n      approveKtt: async () => {\n        data.btn.swaploading = true\n        try {\n          await data.kttContract.methods.approve(config.swapAddress, MaxUint256).send({from: data.address})\n          Toast('授权成功')\n          data.getKttAllowance()\n          data.btn.swaploading = false\n        } catch (error) {\n          Toast('授权失败')\n          data.btn.swaploading = false\n        }\n        \n      },\n      swapKtm: async () => {\n        if(!data.swapAmount) {\n          Toast('请先输入数量')\n          return\n        }\n        if(Number(data.swapAmount) > Number(data.kttBalance)) {\n          Toast('KTT余额不足')\n          return\n        }\n         let introUserInfo = await data.swapContract.methods.getUserInfo(data.intro).call()\n           let userUserInfo = await data.swapContract.methods.getUserInfo(data.address).call()\n        if(introUserInfo.intro == AddressZero && data.intro != config.rootAddress && userUserInfo.intro == AddressZero) {\n          Toast('推荐人无效')\n          return\n        }\n         data.btn.swaploading = true\n          let decimals = await data.kttContract.methods.decimals().call()\n          let amount = new BigNumber(data.swapAmount).multipliedBy(10 ** decimals).toFixed()\n        try {\n          await data.swapContract.methods.stake(data.pickerValue.value,amount, data.intro).send({from: data.address})\n          Toast('质押成功')\n           data.initData()\n          data.btn.swaploading = false\n        } catch (error) {\n          Toast('质押失败')\n          data.btn.swaploading = false\n        }\n      },\n      getOutKtmAmount: _.throttle(async function(){\n        if (!data.swapAmount || Number(data.swapAmount)  == 0) {\n          data.ktmAmount = '0.00'\n          return '0.00'\n        }\n        let kttDecimals = await data.kttContract.methods.decimals().call()\n         let ktmDecimals = await data.ktmContract.methods.decimals().call()\n         let amount = new BigNumber(data.swapAmount).multipliedBy(10 ** kttDecimals).toFixed()\n        let price = await data.swapContract.methods.getKtmAmount(amount).call()\n        data.ktmAmount = new BigNumber(price).multipliedBy(data.pickerValue.rate).dividedBy(10000).dividedBy(10**ktmDecimals).toFixed(2)\n      }, 1000)\n    })\n    if (data.address) {\n      data.initContract()\n    }\n    watch(() => data.address, (val) => {\n      if (val) {\n        data.initContract()\n      }\n    })\n    const refData = toRefs(data);\n    return {\n      ...refData\n    };\n  }\n}\n</script>\n<style lang=\"less\" scoped>\n.swap{\n  padding: 16px;\n}\n.sympol{\n    font-size: 14px;\n}\n.swap-item{\n  background: #3F2E6F;\n  border-radius: 5px;\n  padding: 20px 14px;\n  margin-bottom: 15px;\n  .title{\n    text-align: center;\n    color: #fff;\n    font-size: 16px;\n    font-weight: 600;\n    margin-bottom: 20px;\n  }\n  .price-desc{\n    font-size: 12px;\n    font-weight: 600;\n    color: #E4D7FF;\n    margin: 15px 8px;\n    span{\n      color: #FFD511;\n    }\n  }\n}\n</style>\n","import { render } from \"./index.vue?vue&type=template&id=6914fe30&scoped=true\"\nimport script from \"./index.vue?vue&type=script&lang=js\"\nexport * from \"./index.vue?vue&type=script&lang=js\"\n\nimport \"./index.vue?vue&type=style&index=0&id=6914fe30&lang=less&scoped=true\"\n\nimport exportComponent from \"/Users/wangyouquan/priviteProject/ketai/ketai-vue/node_modules/vue-loader-v16/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render],['__scopeId',\"data-v-6914fe30\"]])\n\nexport default __exports__","export * from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--11-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--11-oneOf-1-1!../../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--11-oneOf-1-2!../../../node_modules/less-loader/dist/cjs.js??ref--11-oneOf-1-3!../../../node_modules/style-resources-loader/lib/index.js??ref--11-oneOf-1-4!../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../node_modules/vue-loader-v16/dist/index.js??ref--1-1!./index.vue?vue&type=style&index=0&id=6914fe30&lang=less&scoped=true\""],"sourceRoot":""}